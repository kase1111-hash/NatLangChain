# NatLangChain Live Contracts

## Overview

NatLangChain Live Contracts enable **self-seeking autonomous contract matching** with AI-mediated negotiation and miner incentives. Contracts are natural language entries that automatically find compatible matches, negotiate terms through LLM mediation, and reward successful matchers.

This implementation represents **Phase 1-4** of the Self-Seeking Live Contracts roadmap:
- ✅ Contract structure and posting
- ✅ Semantic matching logic
- ✅ Negotiation and mediation
- ✅ Foundation for miner incentives

## Key Features

### 1. **Natural Language Contracts**
Post contracts in plain English - the system extracts structured terms automatically.

### 2. **Autonomous Matching**
During mining, the system automatically finds semantically compatible contracts and proposes matches.

### 3. **AI-Mediated Negotiation**
When parties counter-offer, the LLM acts as a neutral mediator suggesting fair compromises.

### 4. **Miner Incentives**
Miners who successfully match contracts earn facilitation fees from the terms.

## Contract Types

### Offer
A party offering goods, services, or value.

**Example:**
```
[CONTRACT: OFFER] Private detective services for investigating supply chain fraud.
Available for 2-week engagement. [TERMS: fee=0.5BTC, facilitation=1%, escrow=USDC]
```

### Seek
A party seeking goods, services, or value.

**Example:**
```
[CONTRACT: SEEK] Looking for experienced blockchain forensic analyst to trace
stolen assets. Budget up to $50,000. [TERMS: deadline=30days, payment=USDC, facilitation=2%]
```

### Proposal
Auto-generated by miners when compatible contracts are found.

**Example:**
```
[PROPOSAL: Match 87%] Contract proposal between detective_agency and fraud_victim.
The detective's forensic expertise aligns with the fraud investigation needs...
```

### Response
Party's response to a proposal (accept, counter, or reject).

### Closure
Final agreement or termination of negotiation.

### Payout
Miner's claim for facilitation fee.

## API Endpoints

### POST /contract/post

Post a new contract (offer or seek).

**Request:**
```json
{
  "content": "I offer cloud infrastructure consulting services...",
  "author": "alice",
  "intent": "Offer cloud consulting",
  "contract_type": "offer",
  "terms": {
    "fee": "$200/hour",
    "facilitation": "1.5%",
    "min_engagement": "1 week"
  },
  "auto_mine": true
}
```

**Response:**
```json
{
  "status": "success",
  "entry": {
    "content": "I offer cloud infrastructure consulting...",
    "metadata": {
      "is_contract": true,
      "contract_type": "offer",
      "status": "open",
      "terms": {
        "fee": "$200/hour",
        "facilitation": "1.5%"
      }
    }
  },
  "mined_block": {
    "index": 5,
    "hash": "000abc..."
  }
}
```

### GET /contract/list

List all contracts with optional filtering.

**Query Parameters:**
- `status` - Filter by status (open, matched, negotiating, closed)
- `type` - Filter by type (offer, seek, proposal)
- `author` - Filter by author

**Example:**
```bash
curl http://localhost:5000/contract/list?status=open&type=offer
```

**Response:**
```json
{
  "count": 3,
  "contracts": [
    {
      "block_index": 2,
      "block_hash": "000def...",
      "entry": {
        "content": "...",
        "metadata": {
          "is_contract": true,
          "contract_type": "offer",
          "status": "open"
        }
      }
    }
  ]
}
```

### POST /contract/respond

Respond to a contract proposal.

**Request:**
```json
{
  "to_block": 2,
  "to_entry": 0,
  "response_content": "I accept the proposal with one modification: payment in 2 installments",
  "author": "bob",
  "response_type": "counter",
  "counter_terms": {
    "payment_schedule": "50% upfront, 50% on completion"
  }
}
```

**Response (with AI Mediation):**
```json
{
  "status": "success",
  "response": {
    "content": "[RESPONSE TO: 000def12] I accept the proposal...",
    "metadata": {
      "response_type": "counter",
      "negotiation_round": 1
    }
  },
  "mediation": {
    "points_of_agreement": [
      "Scope of work",
      "Total fee amount"
    ],
    "differences": [
      "Payment schedule"
    ],
    "suggested_compromise": "60% upfront, 40% on completion",
    "recommended_action": "CONTINUE",
    "revised_terms": {
      "payment_schedule": "60% upfront, 40% on completion"
    }
  }
}
```

### POST /mine

Mine blocks with automatic contract matching.

**Request:**
```json
{
  "difficulty": 2,
  "miner_id": "miner_alice"
}
```

**Response:**
```json
{
  "status": "success",
  "message": "Block mined successfully",
  "block": {
    "index": 3,
    "hash": "000ghi...",
    "entries": [...]
  },
  "contract_proposals": 2,
  "proposals": [
    {
      "content": "[PROPOSAL: Match 89%] Match between alice and bob...",
      "metadata": {
        "match_score": 89,
        "terms": {
          "miner": "miner_alice",
          "facilitation": "1.5%"
        }
      }
    }
  ]
}
```

## How Matching Works

### 1. Semantic Analysis

When mining, the matcher compares pending contracts with all open contracts using LLM-based semantic similarity:

```
CONTRACT A (Offer): "Cloud infrastructure consulting, AWS/Azure expert"
CONTRACT B (Seek): "Need help migrating our services to cloud platform"

LLM Analysis:
- Score: 87%
- Compatibility: "Complementary - consultant offers exactly what seeker needs"
- Recommendation: MATCH
```

### 2. Match Threshold

Default threshold is 80%. Scores above this trigger automatic proposals.

You can configure:
```python
contract_matcher = ContractMatcher(api_key, match_threshold=85)
```

### 3. Proposal Generation

The LLM generates a merged proposal in natural language:

```
[PROPOSAL: Match 87%] Contract proposal between cloud_consultant and startup_cto.

The consultant's expertise in AWS/Azure cloud infrastructure aligns perfectly with
the startup's need for cloud migration services. Proposed terms:
- Engagement: 2-week initial consultation
- Fee: $200/hour
- Total estimated: $16,000
- Payment: 50% upfront, 50% on completion
- Miner facilitation: 1.5% ($240)

Next steps: Parties review and accept/counter within 5 blocks.
```

### 4. Negotiation Rounds

If a party counters:

1. **Round 1**: Original proposal
2. **Round 2**: First counter-offer → LLM mediates
3. **Round 3**: Second counter → LLM suggests compromise
4. **Round 4-5**: Continue or recommend termination

The LLM acts as neutral mediator:
- Identifies points of agreement
- Highlights remaining differences
- Suggests fair middle ground
- Recommends action (continue/accept/terminate)

## Miner Incentives

### Facilitation Fees

Miners earn fees for successful matches extracted from contract terms:

```
Terms: { "facilitation": "1.5%", "total_value": "$16,000" }
Miner fee: $240
```

### Fee Claims

When a contract closes successfully, the miner creates a PAYOUT entry:

```
[PAYOUT] Miner miner_alice claims 1.5% facilitation fee ($240) from
contracts [hash1, hash2]. Payment to wallet 0xABC...
```

### Future: On-Chain Settlement

Phase 5 will add:
- Escrow integration (USDC, BTC)
- Automatic payouts on closure
- Reputation tracking for miners
- Stake requirements for large matches

## Contract Format

### Tagged Format (Explicit)

```
[CONTRACT: OFFER] Description of offering
[TERMS: key1=value1, key2=value2, ...]
[LINKS: hash1, hash2] (optional, for responses)
```

### Natural Format (LLM-Parsed)

```
I'm offering freelance blockchain development services. I charge $150/hour
with a 1-week minimum engagement. Payment in USDC, and I require a 2%
facilitation fee for any matching service.
```

The LLM extracts:
```json
{
  "fee": "$150/hour",
  "min_engagement": "1 week",
  "payment": "USDC",
  "facilitation": "2%"
}
```

## Validation

### Clarity Checks

Before accepting a contract, the system validates for ambiguity:

**REJECTED:**
```
"I'll do some work soon for around $1000"
```
- Vague: "some work", "soon", "around"
- Missing: specific deliverables, timeline, exact amount

**ACCEPTED:**
```
"I will develop a React frontend for the e-commerce platform within 3 weeks
for $5,000, payable 50% upfront and 50% on delivery of working code with tests."
```
- Specific: deliverable, timeline, amount, payment terms

### Dialectic Validation

For critical contracts, use dialectic consensus:

```bash
curl -X POST http://localhost:5000/contract/post \
  -d '{
    "content": "...",
    "validation_mode": "dialectic"
  }'
```

The Skeptic/Facilitator debate ensures unambiguous terms before posting.

## Use Cases

### 1. Freelance Services Marketplace

**Offers:**
- Developers, designers, writers posting availability
- Specific skills, rates, availability windows

**Seeks:**
- Companies/individuals posting project needs
- Budget ranges, timelines, requirements

**Matching:**
- Auto-match React developer with React project need
- Mediate rate negotiations
- Miners earn % of final contract value

### 2. Supply Chain Coordination

**Offers:**
- Manufacturers offering production capacity
- Logistics providers offering shipping

**Seeks:**
- Buyers seeking specific products
- Distribution needs

**Matching:**
- Match supplier capacity with buyer demand
- Negotiate delivery terms, pricing
- Track fulfillment on-chain

### 3. Financial Instruments

**Offers:**
- "Sell 100 BTC call options, strike $50k, exp 30 days"

**Seeks:**
- "Buy BTC call options, budget $10k"

**Matching:**
- Semantic match on instrument type, parameters
- Mediate strike price, premium
- Settle via smart contract integration

## Configuration

### Environment Variables

```bash
# Required for contract features
ANTHROPIC_API_KEY=your_key_here

# Optional
CONTRACT_MATCH_THRESHOLD=80  # 0-100, minimum match score
MAX_NEGOTIATION_ROUNDS=5     # Auto-terminate after N rounds
```

### Match Threshold

Higher threshold = fewer but higher-quality matches:

- `60-70`: Experimental, many matches (may include weak ones)
- `80`: Recommended default (good balance)
- `90-95`: Very conservative (only excellent matches)

## Testing

### Manual Test Flow

1. **Post an offer:**
```bash
curl -X POST http://localhost:5000/contract/post \
  -H "Content-Type: application/json" \
  -d '{
    "content": "[CONTRACT: OFFER] Web development services, $100/hour",
    "author": "alice",
    "intent": "Offer web dev services",
    "contract_type": "offer",
    "terms": {"fee": "$100/hour", "facilitation": "2%"}
  }'
```

2. **Post a matching seek:**
```bash
curl -X POST http://localhost:5000/contract/post \
  -H "Content-Type: application/json" \
  -d '{
    "content": "[CONTRACT: SEEK] Need experienced web developer for e-commerce site",
    "author": "bob",
    "intent": "Hire web developer",
    "contract_type": "seek",
    "terms": {"budget": "$5000", "deadline": "2 weeks"}
  }'
```

3. **Mine to trigger matching:**
```bash
curl -X POST http://localhost:5000/mine \
  -H "Content-Type: application/json" \
  -d '{
    "miner_id": "miner_charlie",
    "difficulty": 1
  }'
```

4. **Check proposals:**
```bash
curl http://localhost:5000/contract/list?type=proposal
```

5. **Respond to proposal:**
```bash
curl -X POST http://localhost:5000/contract/respond \
  -H "Content-Type: application/json" \
  -d '{
    "to_block": 2,
    "to_entry": 0,
    "response_content": "I accept with payment in 3 installments",
    "author": "bob",
    "response_type": "counter",
    "counter_terms": {"payment": "3 installments"}
  }'
```

## Roadmap

### Phase 1-4: ✅ **COMPLETED**
- Contract structure and parsing
- Semantic matching with LLM
- API endpoints for posting, listing, responding
- Auto-matching during mining
- Negotiation mediation
- Foundation for miner fees

### Phase 5: **PLANNED**
- Multi-node consensus on matches
- Escrow integration (USDC, BTC)
- Automatic fee payouts
- Reputation system for miners
- Advanced matching algorithms
- Contract templates library
- Web UI for contract browsing

### Future Enhancements
- Cross-chain interoperability
- Privacy-preserving contracts (zero-knowledge)
- Conditional execution triggers
- Dispute resolution protocols
- Insurance products for contracts

## Security Considerations

### 1. Sybil Attacks
- Rate limiting on contract posts
- Stake requirements for high-value contracts
- Reputation tracking

### 2. Malicious Matching
- Multi-validator consensus on proposals
- Minimum match score threshold
- Parties can always reject proposals

### 3. Fee Gaming
- Facilitation fees extracted from validated terms
- Transparent on-chain records
- Community oversight

### 4. Privacy
- Optional off-chain negotiation
- Zero-knowledge proofs for sensitive terms (future)
- Encrypted contract details with public summaries

## Performance

### Expected Throughput

**Single-node (current):**
- Contract posts: ~10/second
- Matching: ~1-2 contracts/second (LLM-dependent)
- Mining with matching: ~30-60 seconds/block

**Multi-node (future):**
- Horizontal scaling of matching
- Specialized matchers for contract categories
- Parallel validation

### Cost Optimization

**LLM Costs:**
- Match computation: ~500 tokens per comparison
- For 10 open contracts + 5 new: ~5,000 tokens/mine
- At $0.003/1k tokens: ~$0.015/mine

**Optimization:**
- Cache frequent patterns
- Batched API calls
- Local model fallback for simple matches
- Selective LLM use (only for high-value contracts)

## Conclusion

NatLangChain Live Contracts bring autonomous contract matching to the blockchain, combining:
- **Natural language** accessibility
- **AI-powered** semantic understanding
- **Decentralized** execution
- **Economic incentives** for matchers

This enables a new class of applications where contracts seek each other out, negotiate autonomously, and settle on-chain with minimal human intervention.

Start experimenting with the API today!
