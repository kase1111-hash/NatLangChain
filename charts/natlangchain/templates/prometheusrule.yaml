{{- if and .Values.metrics.enabled .Values.metrics.prometheusRule.enabled }}
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: {{ include "natlangchain.fullname" . }}
  {{- if .Values.metrics.prometheusRule.namespace }}
  namespace: {{ .Values.metrics.prometheusRule.namespace }}
  {{- end }}
  labels:
    {{- include "natlangchain.labels" . | nindent 4 }}
    {{- with .Values.metrics.prometheusRule.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
spec:
  groups:
    - name: natlangchain
      rules:
        - alert: NatLangChainDown
          expr: up{job="{{ include "natlangchain.fullname" . }}"} == 0
          for: 1m
          labels:
            severity: critical
          annotations:
            summary: "NatLangChain is down"
            description: "NatLangChain instance {{ "{{ $labels.instance }}" }} has been down for more than 1 minute."

        - alert: NatLangChainHighLatency
          expr: |
            histogram_quantile(0.95,
              sum(rate(http_request_duration_seconds_bucket{job="{{ include "natlangchain.fullname" . }}"}[5m])) by (le)
            ) > 5
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "High API latency"
            description: "P95 latency is {{ "{{ $value | printf \"%.2f\" }}" }}s"

        - alert: NatLangChainHighErrorRate
          expr: |
            (sum(rate(http_requests_total{job="{{ include "natlangchain.fullname" . }}", status=~"5.."}[5m]))
            / sum(rate(http_requests_total{job="{{ include "natlangchain.fullname" . }}"}[5m]))) * 100 > 5
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "High error rate"
            description: "Error rate is {{ "{{ $value | printf \"%.2f\" }}" }}%"

        - alert: NatLangChainChainInvalid
          expr: natlangchain_chain_valid == 0
          for: 1m
          labels:
            severity: critical
          annotations:
            summary: "Blockchain validation failed"
            description: "Chain validation has failed"

        {{- with .Values.metrics.prometheusRule.additionalRules }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
{{- end }}
